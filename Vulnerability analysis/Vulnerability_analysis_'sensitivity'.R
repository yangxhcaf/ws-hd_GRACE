library(raster); library(dplyr); library(magrittr); library(rgdal); library(sp)
library(spatstat); library(ggplot2); library(RColorBrewer); library(tmap); library(tmaptools); 

if(!is.null(dev.list())) dev.off(); cat("\014");rm(list=ls()) # clear all
setwd("Z:/2.active_projects/Xander/! GIS_files")

# import data  
### Hazard levels
Scarcity_kf <- raster("./WaterScarcityAtlas/Categorized_shortage_2001t2010.tif") # shortage hazard levels
Floods_dfo <- raster("./DartmouthFloodingObservatory/FPU_flood_categorized.tif") # flood hazard levels

### Population data, world regions, WGS84 grid areas, and adaptive capacity for analysis
Pop <- raster("./R_gis_exports/POP_2015_0d05_UNWPP.tif") # Population data from GWPv4 UNWPP 2015 at 0.05
WorldRegions <- raster("./WorldRegions/MAgPIE_worldregions.tif") # world regions as per MAgPIE 
GridArea <- raster("./R_gis_exports/WGS84_cellArea_0d05res.tif") # Grid area estimate for WGS84 reference elipsoid
AdaptCap <- raster("./Varis_AdaptiveCapacity/AC_2015_0d05.tif") # VAris et al. AC for 2015 

### FPU polygons w/ sd of TWS as pct of precip, and FPU grids
FPU_grid <- raster("./WaterScarcityAtlas/fpu30_hyde_compatible_v20d05.tif")
FPU_mod <- readOGR(dsn = "./R_gis_exports", "Zscore_modify")
TWS_mod_r <- raster::rasterize(FPU_mod, GridArea, field = "mod", fun = 'last')

### Regions to exclude from analysis (earthquake interference, outside of FPU boundaries)
EQ_regions <- raster("./Earthquakes/EQ_rm_0d05.tif") # earthquake regions to remove
Scarcity_kf[EQ_regions[] == 1 | FPU_grid[] == 0] <- NA
Floods_dfo[EQ_regions[] == 1 | FPU_grid[] == 0] <- NA
TWS_mod_r[EQ_regions[] == 1 | FPU_grid[] == 0] <- NA
AdaptCap[EQ_regions[] == 1 | FPU_grid[] == 0] <- NA
Pop[EQ_regions[] == 1 | FPU_grid[] == 0] <- NA
GridArea[EQ_regions[] == 1 | FPU_grid[] == 0] <- NA

# 2. Derive TWS modification function for water stress and flooding risk data
MODIFICATION_f <- raster(GridArea); MODIFICATION_s <- raster(GridArea) # initialize both raster files

## 2.a Create flood modification raster (2 sd = maximum class modification of 1.00)
MODIFICATION_f <- TWS_mod_r/2

## 2.b Create scarcity modification raster
MODIFICATION_s[] <- MODIFICATION_f[]*(-1) # the negative of the flooding modification raster

# 2. Modify current scarcity and flooding hazard levels by GRACE scaler
Modified_scarcity   <- raster(GridArea); Modified_flood <- raster(GridArea) # initialize both raster files
Modified_flood[]    <- Floods_dfo[] + MODIFICATION_f[] # modified flood raster
Modified_flood[Modified_flood > 5] <- 5
Modified_flood[Modified_flood < 0] <- 0

Modified_scarcity[] <- Scarcity_kf[] + MODIFICATION_s[] # modified stress raster
Modified_scarcity[Modified_scarcity > 5] <- 5
Modified_scarcity[Modified_scarcity < 0] <- 0

### Create new variables to remove any confusion, and normalize from 0 - 1
Hazard_FLOOD_o <- Floods_dfo/5
Hazard_FLOOD_m <- Modified_flood/5

Hazard_SCARCITY_o <- Scarcity_kf/5
Hazard_SCARCITY_m <- Modified_scarcity/5

#  Evaluate vulnerability by: Vulnerability = Hazard - Adaptive capacity
## To flooding
Vuln_FLOOD_o <- Hazard_FLOOD_o - AdaptCap
Vuln_FLOOD_m <- Hazard_FLOOD_m - AdaptCap

Vuln_SCARCITY_o <- Hazard_SCARCITY_o - AdaptCap
Vuln_SCARCITY_m <- Hazard_SCARCITY_m - AdaptCap


# world region ID index: 1 - NAM | 2 - FSU | 3 - POECD | 4 - PAS | 5 - CPA | 6 - SAS | 7 - SSA | 8 _ MENA | 9 - WEUR | 10 - LAM 
GADM <- raster("./GADM/GADM_level0_0d05.tif")

PercentilePopulator <- function(CountryRAS, PopulatorRAS, WeightRAS, p1, namer){
  temp_df <- cbind(as.data.frame(CountryRAS), as.data.frame(PopulatorRAS), as.data.frame(WeightRAS)) %>%
    set_colnames(c("Country", "Par", "Weight"))
  temp_df <- temp_df[complete.cases(temp_df$Par),] # remove regions with no parameter
  temp_df <- temp_df[complete.cases(temp_df$Country),] # remove regions with no country info
  temp_df$Country %<>% as.factor()
  
  stat_df <- temp_df %>% group_by(Country) %>%
    summarise(t.name1 = weighted.quantile(Par, Weight, probs = p1, na.rm = T)) %>% as.data.frame() %>%
    set_colnames(c("GADM", paste0(namer,p1*100)))
  return(stat_df)
}

SumPopulator <- function(CountryRAS, PopulatorRAS){
  temp_df <- cbind(as.data.frame(CountryRAS), as.data.frame(PopulatorRAS)) %>% set_colnames(c("Country", "Par"))
  temp_df <- temp_df[complete.cases(temp_df$Country),] # remove regions with no country info
  temp_df$Country %<>% as.factor()
  
  stat_df <- temp_df %>% group_by(Country) %>%
    summarise(t.name = sum(Par, na.rm = TRUE)) %>%  as.data.frame() %>% set_colnames(c("GADM", "Pop"))
  return(stat_df)
}

RegionID <- function(CountryRAS, RegionRAS, AreaRAS){
  temp_df <- cbind(as.data.frame(GADM), as.data.frame(WorldRegions), as.data.frame(GridArea)) %>%
    set_colnames(c("Country","Region", "Area"))
  temp_df <- temp_df[complete.cases(temp_df),] # keep only complete data sets
  temp_df$Country %<>% as.factor()
  
  stat_df <- temp_df %>% group_by(Country) %>%
    summarise(t.name = round(weighted.quantile(x = Region, w = Area, probs = 0.50, na.rm = T), digits = 0)) %>% 
    as.data.frame() %>% set_colnames(c("GADM", "Region"))
  return(stat_df)
}

GADM_Vul_Flooding   <- PercentilePopulator(GADM, Vuln_FLOOD_m, Pop, 0.50, "V_flood")
GADM_Vul_Flooding_o <- PercentilePopulator(GADM, Vuln_FLOOD_o, Pop, 0.50, "V_flood_o")
GADM_Vul_Scarcity   <- PercentilePopulator(GADM, Vuln_SCARCITY_m, Pop, 0.50, "V_scarce")
GADM_Vul_Scarcity_o <- PercentilePopulator(GADM, Vuln_SCARCITY_o, Pop, 0.50, "V_scarce_o")
GADM_Haz_Flooding   <- PercentilePopulator(GADM, Hazard_FLOOD_m, Pop, 0.50, "H_flood") 
GADM_Haz_Flooding_o <- PercentilePopulator(GADM, Hazard_FLOOD_o, Pop, 0.50, "H_flood_o") 
GADM_Haz_Scarcity   <- PercentilePopulator(GADM, Hazard_SCARCITY_m, Pop, 0.50, "H_scarce") 
GADM_Haz_Scarcity_o <- PercentilePopulator(GADM, Hazard_SCARCITY_o, Pop, 0.50, "H_scarce_o") 
GADM_AdaptiveCap  <- PercentilePopulator(GADM, AdaptCap, Pop, 0.50, "AdapCap") 
GADM_WorldRegion   <- RegionID(GADM, WorldRegions, GridArea)
GADM_Pop_p50       <- SumPopulator(GADM, Pop) 

# merge all 
Plot_df <- Reduce(function(x, y) merge(x, y, by = "GADM"), list(GADM_Vul_Flooding, GADM_Vul_Flooding_o,
                                                                GADM_Vul_Scarcity, GADM_Vul_Scarcity_o,
                                                                GADM_Haz_Flooding, GADM_Haz_Flooding_o,
                                                                GADM_Haz_Scarcity, GADM_Haz_Scarcity_o,
                                                                GADM_AdaptiveCap, GADM_WorldRegion,
                                                                GADM_Pop_p50))
Plot_df$Region %<>% as.factor()

## import GADM identifier for country names
GADM.id <- read.csv("./GADM/Country_id_gadm.csv") %>% as.data.frame() %>% select("GID_0", "NAME_0", "ID")
Plot_df <- merge(x = Plot_df, y = GADM.id, by.x = "GADM", by.y = "ID", all = F)
Plot_df <- Plot_df[order(-Plot_df$Pop),]

GlobalStats <- function(ParameterRAS, WeightRAS, p1, p2, p3, namer){
  temp_df <- cbind(as.data.frame(ParameterRAS), as.data.frame(WeightRAS)) %>% as.data.frame() %>%
    set_colnames(c("Par", "Weight"))
  temp_df <- temp_df[complete.cases(temp_df),] # remove regions with incomplete data
  
  stat1 <- weighted.quantile(temp_df$Par, temp_df$Weight, probs = p1, na.rm = T)
  stat2 <- weighted.quantile(temp_df$Par, temp_df$Weight, probs = p2, na.rm = T)
  stat3 <- weighted.quantile(temp_df$Par, temp_df$Weight, probs = p3, na.rm = T)
  stat_df <- cbind(stat1, stat2, stat3) %>% as.data.frame() %>% 
    set_colnames(c(paste0(namer, p1*100), paste0(namer, p2*100), paste0(namer, p3*100)))
}

Global_flooding_V <- GlobalStats(Vuln_FLOOD_m, Pop, 0.25, 0.50, 0.75, "Flood_V")
Global_scarcity_V <- GlobalStats(Vuln_SCARCITY_m, Pop, 0.25, 0.50, 0.75, "Scarcity_V")
Global_flooding_H <- GlobalStats(Hazard_FLOOD_m, Pop, 0.25, 0.50, 0.75, "Flood_H")
Global_scarcity_H <- GlobalStats(Hazard_SCARCITY_m, Pop, 0.25, 0.50, 0.75, "Scarcity_H")
Global_AdaptivCap <- GlobalStats(AdaptCap, Pop, 0.25, 0.50, 0.75, "AdaptCap")

#### for diagonal "error bars", need to create seperate df
df_error_o <- Plot_df %>% select(c("GADM", "V_flood_o50", "V_scarce_o50", "Pop")) %>% 
  set_colnames(c("GADM", "Fl", "Sc", "Pop"))
df_error_m <- Plot_df %>% select(c("GADM", "V_flood50", "V_scarce50", "Pop")) %>%
  set_colnames(c("GADM", "Fl", "Sc", "Pop"))
df_error <- rbind(df_error_o, df_error_m); df_error$GADM %<>% as.numeric()

figure <- ggplot(data = filter(Plot_df, Pop > 5e6), aes(x = H_scarce50, y = AdapCap50, label = GID_0)) +
  geom_vline(xintercept = Global_scarcity_H$Scarcity_H25[1], lwd = 1.1, color = "grey60") +
  geom_vline(xintercept = Global_scarcity_H$Scarcity_H75[1], lwd = 1.1, color = "grey60") +
  geom_hline(yintercept = Global_AdaptivCap$AdaptCap25[1], lwd = 1.1, color = "grey60") +
  geom_hline(yintercept = Global_AdaptivCap$AdaptCap75[1], lwd = 1.1, color = "grey60") +
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.major = element_line(colour = "grey50", linetype = "dashed", size = 0.7),
        legend.title = element_blank(),
        axis.text = element_text(face = "bold", size = 10, color = "black")) +
  geom_jitter(shape = 21, width = 0.0, height = 0.0, aes(fill = Region, size = Pop), alpha = 1) +
  scale_fill_brewer(palette = "Set3") +
  scale_size(range = c(2, 14), breaks = c(5e6, 50e6, 500e6, 1000e6), labels = c("5M", "50M", "500M", "1B"))+
  # coord_cartesian(xlim = c(-1.05, 1.05), ylim = c(-1.05, 1.05)) +         # this line for vulnerability plot
  # scale_x_continuous(expand = c(0, 0),breaks = c(seq(-1, 1, by = 0.5))) + # ... and this line
  # scale_y_continuous(expand = c(0, 0), breaks = c(seq(-1, 1, by = 0.5)))  # ... and this line
  coord_cartesian(xlim = c(-0.05, 1.05), ylim = c(-0.05, 1.05)) +           # this line for hazard plots
  scale_x_continuous(expand = c(0, 0),breaks = c(seq(0, 1, by = 0.25))) +   # ... and this line
  scale_y_continuous(expand = c(0, 0), breaks = c(seq(0, 1, by = 0.25))) +   # ... and this line
  geom_errorbarh(aes(xmin=H_scarce_o50, xmax=H_scarce50)) +
  # geom_line(data = filter(df_error, Pop > 5e6), aes(x = Sc, y = Fl, group = GADM), lwd = 0.5)+
  geom_point(data = filter(Plot_df, Pop > 5e6), aes(x = H_scarce_o50, y=AdapCap50), shape = 16, size = 1)
figure

ggsave("C:/Users/Tom/Desktop/SENSITIVITY_scarcity_scatter.png", 
       figure, dpi = 500, width = 0.91508*900*0.2645833333, height = 750*0.2645833333, units = "mm", bg = "transparent")


#############. 
## create boxplots for regional summaries
library(forcats)

CalcBoxplots <- function(RegionRAS, Parameter, Weight, p1, p2, p3, p4, p5, namer){
  temp_df <- cbind(as.data.frame(RegionRAS), as.data.frame(Parameter), as.data.frame(Weight)) %>%
    as.data.frame() %>% set_colnames(c("Region", "Par", "Weight"))
  temp_df <- temp_df[complete.cases(temp_df),] # remove regions with incomplete data
  temp_df$Region %<>% as.factor()
  
  stat_df <- temp_df %>% group_by(Region) %>%
    summarise(t.name1 = weighted.quantile(Par, Weight, probs = p1, na.rm = T),
              t.name2 = weighted.quantile(Par, Weight, probs = p2, na.rm = T),
              t.name3 = weighted.quantile(Par, Weight, probs = p3, na.rm = T),
              t.name4 = weighted.quantile(Par, Weight, probs = p4, na.rm = T),
              t.name5 = weighted.quantile(Par, Weight, probs = p5, na.rm = T)) %>%  
    as.data.frame() %>% set_colnames(c("Region", paste0(namer,p1*100), paste0(namer,p2*100), paste0(namer,p3*100),
                                       paste0(namer,p4*100), paste0(namer,p5*100)))
  stat_df$Region %<>% as.factor()
  return(stat_df)
}

Scarcity_boxplot   <- CalcBoxplots(WorldRegions, Vuln_SCARCITY_m, Pop, 0.05, 0.25, 0.50, 0.75, 0.95, "Scarcity")
Scarcity_boxplot_o <- CalcBoxplots(WorldRegions, Vuln_SCARCITY_o, Pop, 0.05, 0.25, 0.50, 0.75, 0.95, "Scarcity")
Flooding_boxplot   <- CalcBoxplots(WorldRegions, Vuln_FLOOD_m, Pop, 0.05, 0.25, 0.50, 0.75, 0.95, "Flooding")
Flooding_boxplot_o <- CalcBoxplots(WorldRegions, Vuln_FLOOD_o, Pop, 0.05, 0.25, 0.50, 0.75, 0.95, "Flooding")

boxplot_s <- ggplot(Scarcity_boxplot) +
  # scale_x_discrete(limsits=c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")) +
  geom_boxplot(aes(x = Region, ymin = Scarcity5, lower = Scarcity25, middle = Scarcity50,
                   upper = Scarcity75, ymax = Scarcity95, fill = Region), 
               stat = "identity", lwd = 1, width = 0.8) +  scale_fill_brewer(palette="Set3") +
  
  geom_boxplot(data = Scarcity_boxplot_o, 
               aes(x = Region, ymin = Scarcity5, lower = Scarcity25, middle = Scarcity50,
                   upper = Scarcity75, ymax = Scarcity95, fill = Region), 
               stat = "identity", fill = NA, lwd = 1, width = 0.5, col = "blue") +  
  # scale_y_continuous(breaks = seq(-3, 3, by = 1), expand = c(0,0)) +
  theme(panel.background =  element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(),
        panel.grid.major = element_line(alpha(colour = "white", 0.3), linetype = "dashed", size = 0.5),
        axis.line.x = element_line(color = "black", size = 1)) +
  coord_flip(ylim = c(-1, 1))
boxplot_s

boxplot_f <- ggplot(Flooding_boxplot) +
  # scale_x_discrete(limsits=c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")) +
  geom_boxplot(aes(x = Region, ymin = Flooding5, lower = Flooding25, middle = Flooding50,
                   upper = Flooding75, ymax = Flooding95, fill = Region), 
               stat = "identity", lwd = 1, width = 0.8) +  scale_fill_brewer(palette="Set3") +
  
  geom_boxplot(data = Flooding_boxplot_o, 
               aes(x = Region, ymin = Flooding5, lower = Flooding25, middle = Flooding50,
                   upper = Flooding75, ymax = Flooding95, fill = Region), 
               stat = "identity", fill = NA, lwd = 1, width = 0.5, col = "blue") +  
  # scale_y_continuous(breaks = seq(-3, 3, by = 1), expand = c(0,0)) +
  theme(panel.background =  element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(),
        panel.grid.major = element_line(alpha(colour = "white", 0.3), linetype = "dashed", size = 0.5),
        axis.line.x = element_line(color = "black", size = 1)) +
  coord_flip(ylim = c(-1, 1))
boxplot_f

ggsave("C:/Users/Tom/Desktop/SENSITIVITY_flooding_boxplot.png", 
       boxplot_f, dpi = 500, width = 800*0.2645833333, height = 700*0.2645833333, units = "mm", bg = "transparent")

ggsave("C:/Users/Tom/Desktop/SENSITIVITY_scarcity_boxplot.png", 
       boxplot_s, dpi = 500, width = 800*0.2645833333, height = 700*0.2645833333, units = "mm", bg = "transparent")
