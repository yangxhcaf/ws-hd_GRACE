library(raster); library(dplyr); library(magrittr); library(spatstat); library(gdalUtils); library(tmap); library(tmaptools); library(rgdal)
if(!is.null(dev.list())) dev.off(); cat("\014");rm(list=ls())
# set dir
setwd("Z:/2.active_projects/Xander/! GIS_files")

# load input data
GADM_lvl0 <- raster("./GADM/GADM_level0_0d05.tif") # GADM national dataset rasterized to 0.05
Floods  <- raster("./DartmouthFloodingObservatory/FPU_floodcount_1985t2002.tif")
TWS_m     <- raster("./Rodell_SourceData/FPU_meanTWS.tif")
EQ_regions <- raster("./Earthquakes/EQ_rm_0d05.tif") # earthquake regions to remove
FPU <- readOGR(dsn = "./FPU", layer = "Kummu_modified_FPU_collected")

# Remove earthquake and ocean regions
Floods[EQ_regions[] == 1 | is.na(GADM_lvl0[])] <- NA
TWS_m[EQ_regions[] == 1 | is.na(GADM_lvl0[])] <- NA

# create combination categories raster
CombRAS <- raster(TWS_m)
CombRAS[Floods[] >= 9 & TWS_m[] < -0.5] <- 1  # high flood occurrence and drying
CombRAS[Floods[] >= 9  & TWS_m[] >= -0.5 & TWS_m[] <= 0.5] <- 2 # high flood occurrence and stable
CombRAS[Floods[] >= 9  & TWS_m[] > 0.5] <- 3 # high flood occurrence and wetting

CombRAS[Floods[] >= 3 & Floods[] < 9 & TWS_m[] < -0.5] <- 4  # moderate flood occurrence and drying
CombRAS[Floods[] >= 3 & Floods[] < 9 & TWS_m[] >= -0.5 & TWS_m[] <= 0.5] <- 5 # moderate flood occurrence and stable
CombRAS[Floods[] >= 3 & Floods[] < 9 & TWS_m[] > 0.5] <- 6 # moderate flood occurrence and wetting

CombRAS[Floods[] < 3 & TWS_m[] < -0.5] <- 7  # low flood occurrence and drying
CombRAS[Floods[] < 3 & TWS_m[] >= -0.5 & TWS_m[] <= 0.5] <- 8 # low flood occurrence and stable
CombRAS[Floods[] < 3 & TWS_m[] > 0.5] <- 9 # low flood occurrence and wetting

# Send raster data back to FPU polygons
FPU_grid <- raster("./WaterScarcityAtlas/fpu30_hyde_compatible_v20d05.tif")
FPU_grid[FPU_grid < 0] <- NA; FPU_grid[FPU_grid>573] <- NA

FPU_assign <- raster::zonal(CombRAS, FPU_grid, fun = median, na.rm = T)
FPU_assign %<>% as.data.frame()

FPU_m <- merge(x = FPU, y = FPU_assign, by.x = "FPU_id", by.y = "zone", all = T)

Palette1 <- c("#C7D2FF", "#3081BD", "#014182",
              "#FDE5E9", "#EAAFBC", "#A03762",
              "#E5E5E5", "#BFBFBF", "#808080")

# make map plot
data(World)
Grl <- raster("./NaturalEarth/Greenland.tif")
Lakes_ply <- readOGR(dsn=paste("./Lakes", sep=""), layer="ne_10m_lakes")
Lakes_ply$scalerank %<>% as.numeric()
Lakes_large <- subset(Lakes_ply, scalerank < 4)

FPU_m_r <- raster::rasterize(FPU_m, GADM_lvl0, field = "value") # single value per mFPU so 'fun' doesn't matter
FPU_m_r[is.na(GADM_lvl0) | Grl == 1] <- NA

map <- 
  tm_shape(World, projection = "robin") +  tm_polygons(fill = "#c0c0c0", border.alpha = 0) +
  tm_shape(FPU_m_r, projection = "robin") +  tm_raster(style = "cat", palette = Palette1)+
  tm_shape(World) +  tm_borders(lwd = 0.6, "grey40") +
  tm_shape(Lakes_large) + tm_borders("black", lwd = 0.5) +
  tm_style("white", legend.show = T, earth.boundary = c(-180, -60, 180, 88), earth.boundary.color = "white",
           space.color = "white", legend.frame = F, frame = F)
map

tmap_save(map, "C:/Users/Tom/Desktop/Reference_floods.png", dpi = 500, 
          outer.margins = 0.01, height = 3, units = "in")
