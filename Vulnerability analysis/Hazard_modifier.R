library(ncdf4); library(raster); library(magrittr); library(dplyr); library(spatstat)

if(!is.null(dev.list())) dev.off(); cat("\014");rm(list=ls())
setwd("Z:/2.active_projects/Xander/! GIS_files")

# data
TWS <- raster("./Rodell_SourceData/Rodell_etal_0d05.tif")
FPU_grid <- raster("./WaterScarcityAtlas/fpu30_hyde_compatible_v20d05.tif")
GridArea <- raster("./R_gis_exports/WGS84_cellArea_0d5res.tif") # Grid area estimate for WGS84 reference elipsoid

## load global precip data and get 1972-2001 average
AnnualSums_files_gpc c= list.files(path = "./Precipitation/GPCC/AnnualSums",pattern="*.tif")
AnnualSums_files_gpcc <- AnnualSums_files_gpcc[(1+1972-1891):(1+2001-1891)]

AnnualSums_files_cru = list.files(path = "./Precipitation/CRU/AnnualSums",pattern="*.tif")
AnnualSums_files_cru <- AnnualSums_files_cru[(1+1972-1901):(1+2001-1901)]

AnnualSums_files_udel = list.files(path = "./Precipitation/UDEL/AnnualSums",pattern="*.tif")
AnnualSums_files_udel <- AnnualSums_files_udel[(1+1972-1900):(1+2001-1900)]

GPCC <- raster(GridArea); CRU <- raster(GridArea); UDEL <- raster(GridArea)
GPCC[] <- 0; CRU[] <- 0; UDEL[] <- 0

for (i in 1:length(AnnualSums_files_gpcc)){
  tmp_GPCC <- raster(paste("./Precipitation/GPCC/AnnualSums/", AnnualSums_files_gpcc[i], sep = ""))
  tmp_GPCC[is.na(tmp_GPCC)] <- 0
  GPCC <- GPCC + tmp_GPCC
  
  tmp_CRU <- raster(paste("./Precipitation/CRU/AnnualSums/", AnnualSums_files_cru[i], sep = ""))
  tmp_CRU[is.na(tmp_CRU)] <- 0
  CRU <- CRU + tmp_CRU
  
  tmp_UDEL <- raster(paste("./Precipitation/UDEL/AnnualSums/", AnnualSums_files_udel[i], sep = ""))
  tmp_UDEL[is.na(tmp_UDEL)] <- 0
  UDEL <- UDEL + tmp_UDEL
  print(1971+i)
  
}

GPCC_clip <- raster(paste("./Precipitation/GPCC/AnnualSums/", AnnualSums_files_gpcc[i], sep = ""))
CRU_clip <- raster(paste("./Precipitation/CRU/AnnualSums/", AnnualSums_files_cru[i], sep = ""))
UDEL_clip <- raster(paste("./Precipitation/UDEL/AnnualSums/", AnnualSums_files_udel[i], sep = ""))

GPCC_30y <- GPCC/30; GPCC_30y[is.na(GPCC_clip)] <- NA
CRU_30y  <- CRU/30; CRU_30y[is.na(CRU_clip)] <- NA
UDEL_30y <- UDEL/30; UDEL_30y[is.na(UDEL_clip)] <- NA

PrecipStack   <- stack(GPCC_30y, CRU_30y, UDEL_30y)
Precip_mean   <- calc(PrecipStack, fun = mean, na.rm = T)

GridArea <- raster("./R_gis_exports/WGS84_cellArea_0d05res.tif")
Precip_mean_0d05 <- raster::resample(Precip_mean, GridArea, method = "ngb")

Precip_mean_0d05[FPU_grid[] == 0] <- NA
GridArea[is.na(Precip_mean_0d05)] <- NA
TWS[is.na(Precip_mean_0d05)] <- NA

sum(Precip_mean_0d05[]*GridArea[], na.rm = T)/sum(GridArea[], na.rm = T)

# calculate TWS as % of precip
TWS_pct <- 100*(TWS*10)/Precip_mean_0d05 # need to multiply TWS by 10 to convert from cm to mm

# calculate area averaged TWS/precip in FPUs
FPU_grid %<>% as.factor()
FPU_pctsum <- raster::zonal(TWS_pct*GridArea, FPU_grid, fun = "sum", digits = 4)
FPU_areasum <- raster::zonal(GridArea, FPU_grid, fun = "sum", digits = 4)

FPU_pctsum <- FPU_pctsum %>% as.data.frame() %>% set_colnames(c("FPU.id", "w.pct.sum"))
FPU_areasum <- FPU_areasum %>% as.data.frame() %>% set_colnames(c("FPU.id", "area.sum"))

df <- merge(x = FPU_pctsum, y = FPU_areasum, by = "FPU.id", all = T)
df <- df %>% filter(FPU.id != 0) # remove ocean from analysis
df$w.mean <- df$w.pct.sum/df$area.sum
mean(df$w.mean)

## Now recalculate sd removing extreme outliers (min max normalizes to p5 and p95)
p5 <- quantile(df$w.mean, probs = 0.05, names = F)
p95 <- quantile(df$w.mean, probs = 0.95, names = F)
df$w.mean.clip_p5p95 <- ifelse(df$w.mean < p5, p5, ifelse(df$w.mean > p95, p95, df$w.mean))
clip_sd <- sd(df$w.mean.clip_p5p95)
df$Zscore_clipSD <- df$w.mean/clip_sd

## clip to 2 sd 
df$Zscore_2minmax <- ifelse(df$Zscore_clipSD < -2, -2, ifelse(df$Zscore_clipSD > 2, 2, df$Zscore_clipSD))

# remerge with FPU polygon
FPU <- readOGR(dsn = "./FPU", layer = "Kummu_modified_FPU_collected")

FPU_m <- merge(x = FPU, y = df, by.x = "FPU_id", by.y = "FPU.id", all = T)
# FPU_m <- FPU_m[order(-FPU_m$w.mean),]

# make map plot
library(tmap); library(tmaptools); library(RColorBrewer); library(wesanderson)

data(World)
pltmn <- wes_palette("Zissou1", 100, type = "continuous")
Lakes_ply <- readOGR(dsn=paste("./Lakes", sep=""), layer="ne_10m_lakes")
Lakes_ply$scalerank %<>% as.numeric()
Lakes_large <- subset(Lakes_ply, scalerank < 4)

map1 <- 
  tm_shape(World, projection = "robin") +  tm_polygons(fill = "#c0c0c0", border.alpha = 0) +
  tm_shape(FPU_m, projection = "robin") +  tm_polygons(col = "Zscore_clipSD", palette = "RdBu", style = "cont",
  midpoint = 0, breaks = c(-2, 2), lwd = 0.5) +
  # tm_shape(Precip_mean_0d05) + tm_raster(style = "cont", palette = pltmn, breaks = c(0,3000)) +
  tm_shape(Lakes_large) + tm_borders("black", lwd = 0.5) +
  tm_style("white", legend.show = T, earth.boundary = c(-180, -60, 180, 88), earth.boundary.color = "white",
           space.color = "white", legend.frame = F, frame = F)
map1

tmap_save(map1, "C:/Users/Tom/Desktop/Modification_Zscore_modSD.png", dpi = 500, 
          outer.margins = 0.01, height = 3, units = "in")

FPU_w <- FPU_m[,-(2:10)]
names(FPU_w) <- c("FPU_id", "mod")

writeOGR(FPU_w, dsn = "./R_gis_exports", layer = "Zscore_modify", driver = "ESRI Shapefile", overwrite = T)
