library(raster); library(dplyr); library(magrittr); library(spatstat); library(gdalUtils); library(tmap); library(tmaptools); library(rgdal)

# set dir
setwd("Z:/2.active_projects/Xander/! GIS_files")

# load input data
GADM_lvl0 <- raster("./GADM/GADM_level0_0d05.tif") # GADM national dataset rasterized to 0.05
Shortage  <- raster("./WaterScarcityAtlas/Shortage_2001t2010_Kummu_0d05.tif")
TWS_m     <- raster("./Rodell_SourceData/FPU_meanTWS.tif")
EQ_regions <- raster("./Earthquakes/EQ_rm_0d05.tif") # earthquake regions to remove
FPU <- readOGR(dsn = "./FPU", layer = "Kummu_modified_FPU_collected")

# Remove earthquake and ocean regions
Shortage[EQ_regions[] == 1] <- NA
TWS_m[EQ_regions[] == 1] <- NA

# create combination categories raster
CombRAS <- raster(TWS_m)
CombRAS[Shortage[] <= 1000 & TWS_m[] < -0.5] <- 1  # high water shortage and drying
CombRAS[Shortage[] <= 1000 & TWS_m[] >= -0.5 & TWS_m[] <= 0.5] <- 2 # high water shortage and stable
CombRAS[Shortage[] <= 1000 & TWS_m[] > 0.5] <- 3 # high water shortage and wetting

CombRAS[Shortage[] > 1000 & Shortage[] <= 1700 & TWS_m[] < -0.5] <- 4  # high water shortage and drying
CombRAS[Shortage[] > 1000 & Shortage[] <= 1700 & TWS_m[] >= -0.5 & TWS_m[] <= 0.5] <- 5 # high water shortage and stable
CombRAS[Shortage[] > 1000 & Shortage[] <= 1700 & TWS_m[] > 0.5] <- 6 # high water shortage and wetting

CombRAS[Shortage[] > 1700 & TWS_m[] < -0.5] <- 7  # no water shortage and drying
CombRAS[Shortage[] > 1700 & TWS_m[] >= -0.5 & TWS_m[] <= 0.5] <- 8 # no water shortage and stable
CombRAS[Shortage[] > 1700 & TWS_m[] > 0.5] <- 9 # no water shortage and wetting

# Send raster data back to FPU polygons
FPU_grid <- raster("./WaterScarcityAtlas/fpu30_hyde_compatible_v20d05.tif")
FPU_grid[FPU_grid < 0] <- NA; FPU_grid[FPU_grid>573] <- NA

FPU_assign <- raster::zonal(CombRAS, FPU_grid, fun = median, na.rm = T) # fun could be min, max, mean as single value per FPU
FPU_assign %<>% as.data.frame()

FPU_m <- merge(x = FPU, y = FPU_assign, by.x = "FPU_id", by.y = "zone", all = T)

Palette1 <- c("#A30F15", "#DC2C25", "#FB6949",
              "#A03762", "#EAAFBC", "#FDE5E9",
              "#808080", "#BFBFBF", "#E5E5E5")

# make map plot
data(World)
Grl <- raster("./NaturalEarth/Greenland.tif")
Lakes_ply <- readOGR(dsn=paste("./Lakes", sep=""), layer="ne_10m_lakes")
Lakes_ply$scalerank %<>% as.numeric()
Lakes_large <- subset(Lakes_ply, scalerank < 4)

FPU_m_r <- raster::rasterize(FPU_m, GADM_lvl0, field = "value")
FPU_m_r[is.na(GADM_lvl0) | Grl == 1] <- NA

map <- 
  tm_shape(World, projection = "robin") +  tm_polygons(fill = "#c0c0c0", border.alpha = 0) +
  tm_shape(FPU_m_r, projection = "robin") +  tm_raster(style = "cat", palette = Palette1)+
  tm_shape(World) +  tm_borders(lwd = 0.6, "grey40") +
  tm_shape(Lakes_large) + tm_borders("black", lwd = 0.5) +
  tm_style("white", legend.show = T, earth.boundary = c(-180, -60, 180, 88), earth.boundary.color = "white",
           space.color = "white", legend.frame = F, frame = F)
map

tmap_save(map, "C:/Users/Tom/Desktop/Reference_shortage.png", dpi = 500, 
          outer.margins = 0.01, height = 3, units = "in")
