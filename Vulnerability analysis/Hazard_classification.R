library(raster); library(dplyr); library(magrittr); library(spatstat); library(gdalUtils)
if(!is.null(dev.list())) dev.off(); cat("\014");rm(list=ls())
# set dir
setwd("Z:/2.active_projects/Xander/! GIS_files")

# load input data
GADM_lvl0 <- raster("./GADM/GADM_level0_0d05.tif") # GADM national dataset rasterized to 0.05
DFO_count <- raster("./DartmouthFloodingObservatory/FPU_floodcount_1985t2002.tif")

# initialize flooding hazard category raster
DFO_cat <- raster(DFO_count)

# set upper thresholds
LOW <- 1 # i.e. limit on very low
LOW2MED <- 3 # i.e. limit on low 
MED2HIGH <- 8 # i.e. limit on medium
HIGH <- 16 # limit on high, anything higher is very high

DFO_cat[DFO_count <= LOW] <- 0 + ((DFO_count[DFO_count <= LOW] - 0) / (LOW - 0))
DFO_cat[DFO_count > LOW  & DFO_count <= LOW2MED] <- 1 + ((DFO_count[DFO_count > LOW  & DFO_count <= LOW2MED] - LOW) / (LOW2MED - LOW))
DFO_cat[DFO_count > LOW2MED  & DFO_count <= MED2HIGH] <- 2 + ((DFO_count[DFO_count > LOW2MED & DFO_count <= MED2HIGH] - LOW2MED) / (MED2HIGH - LOW2MED))
DFO_cat[DFO_count > MED2HIGH & DFO_count <= HIGH] <- 3 + ((DFO_count[DFO_count > MED2HIGH & DFO_count <= HIGH] - MED2HIGH) / (HIGH - MED2HIGH))
DFO_cat[DFO_count > HIGH] <- 4 + ((DFO_count[DFO_count > HIGH] - HIGH) / (max(DFO_count[], na.rm = T) - HIGH))
DFO_cat[is.na(DFO_cat)] <- 0
DFO_cat[is.na(FPU)] <- NA

writeRaster(DFO_cat, 
            filename="Z:/2.active_projects/Xander/! GIS_files/DartmouthFloodingObservatory/FPU_flood_categorized", 
            format="GTiff", overwrite=TRUE)


##################################################.
## Now import and classify water scarcity data
# import all data
WS <- raster("./WaterScarcityAtlas/Shortage_2001t2010_Kummu_0d05.tif", sep="") # Kummu et al water crowding data

t.1 <- 1e6/100 # Not stressed
t.2 <- 1e6/600 # Near stressed
t.3 <- 1e6/1000 # Stressed
t.4 <- 1e6/2000 # Water barrier
t.l <- 1e6/3000

Shortage_cat <- raster(WS)
Shortage_cat[WS > 4*t.1] <- 0
Shortage_cat[WS >= t.1 & WS < 4*t.1] <- 0 + (1-((WS[WS >= t.1 & WS < 4*t.1] - t.1)/((4*t.1)-t.1)))
Shortage_cat[WS >= t.2 & WS < t.1] <- 1 + (1 - ((WS[WS >= t.2 & WS < t.1] - t.2)/(t.1 - t.2)))
Shortage_cat[WS >= t.3 & WS < t.2] <- 2 + (1 - ((WS[WS >= t.3 & WS < t.2] - t.3)/(t.2 - t.3)))
Shortage_cat[WS >= t.4 & WS < t.3] <- 3 + (1 - ((WS[WS >= t.4 & WS < t.3] - t.4)/(t.3 - t.4)))
Shortage_cat[WS >= t.l & WS <  t.4] <- 4 + ((t.4 - WS[WS >= t.l & WS < t.4])/(t.4 - t.l))
Shortage_cat[WS < t.l] <- 5 

Shortage_cat[is.na(WS)] <- 0
Shortage_cat[is.na(FPU)] <- NA

writeRaster(Shortage_cat, 
            filename="Z:/2.active_projects/Xander/! GIS_files/WaterScarcityAtlas/Categorized_shortage_2001t2010", 
            format="GTiff", overwrite=TRUE)
