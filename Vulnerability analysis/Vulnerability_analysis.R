library(raster); library(dplyr); library(magrittr); library(rgdal); library(R.utils); library(forcats);
library(spatstat); library(ggplot2); library(RColorBrewer); library(ggsci);
library(tmap); library(tmaptools); library(sp); library(gdalUtils)

# clear all
if(!is.null(dev.list())) dev.off(); cat("\014");rm(list=ls())

setwd("Z:/2.active_projects/Xander/! GIS_files")

# import data  

### Hazard levels
Scarcity_kf <- raster("./WaterScarcityAtlas/Categorized_shortage_2001t2010.tif") # shortage hazard levels
Floods_dfo <- raster("./DartmouthFloodingObservatory/FPU_flood_categorized.tif") # flood hazard levels

### Population data, world regions, WGS84 grid areas, and adaptive capacity for analysis
Pop <- raster("./R_gis_exports/POP_2015_0d05_UNWPP.tif") # Population data from GWPv4 UNWPP 2015 at 0.05
WorldRegions <- raster("./WorldRegions/MAgPIE_worldregions.tif") # world regions as per MAgPIE 
GridArea <- raster("./R_gis_exports/WGS84_cellArea_0d05res.tif") # Grid area estimate for WGS84 reference elipsoid
AdaptCap <- raster("./Varis_AdaptiveCapacity/AC_2015_0d05.tif") # VAris et al. AC for 2015 

### FPU polygons w/ sd of TWS as pct of precip, and FPU grids
FPU_grid <- raster("./WaterScarcityAtlas/fpu30_hyde_compatible_v20d05.tif")
FPU_mod <- readOGR(dsn = "./R_gis_exports", "Zscore_modify")
TWS_mod_r <- raster::rasterize(FPU_mod, GridArea, field = "mod", fun = 'last')

### Regions to exclude from analysis (earthquake interference, outside of FPU boundaries)
EQ_regions <- raster("./Earthquakes/EQ_rm_0d05.tif") # earthquake regions to remove
Scarcity_kf[EQ_regions[] == 1 | FPU_grid[] == 0] <- NA
Floods_dfo[EQ_regions[] == 1 | FPU_grid[] == 0] <- NA
TWS_mod_r[EQ_regions[] == 1 | FPU_grid[] == 0] <- NA
AdaptCap[EQ_regions[] == 1 | FPU_grid[] == 0] <- NA
Pop[EQ_regions[] == 1 | FPU_grid[] == 0] <- NA
GridArea[EQ_regions[] == 1 | FPU_grid[] == 0] <- NA

# 2. Derive TWS modification function for water stress and flooding risk data
MODIFICATION_f <- raster(GridArea); MODIFICATION_s <- raster(GridArea) # initialize both raster files

## 2.a Create flood modification raster (2 sd = maximum class modification of 1.00)
MODIFICATION_f <- TWS_mod_r/2

## 2.b Create scarcity modification raster
MODIFICATION_s[] <- MODIFICATION_f[]*(-1) # the negative of the flooding modification raster

# 2. Modify current scarcity and flooding hazard levels by GRACE scaler
Modified_scarcity   <- raster(GridArea); Modified_flood <- raster(GridArea) # initialize both raster files
Modified_flood[]    <- Floods_dfo[] + MODIFICATION_f[] # modified flood raster
Modified_flood[Modified_flood > 5] <- 5
Modified_flood[Modified_flood < 0] <- 0

Modified_scarcity[] <- Scarcity_kf[] + MODIFICATION_s[] # modified stress raster
Modified_scarcity[Modified_scarcity > 5] <- 5
Modified_scarcity[Modified_scarcity < 0] <- 0

### Create new variables to remove any confusion, and normalize from 0 - 1
Hazard_FLOOD_o <- Floods_dfo/5
Hazard_FLOOD_m <- Modified_flood/5

Hazard_SCARCITY_o <- Scarcity_kf/5
Hazard_SCARCITY_m <- Modified_scarcity/5

#  Evaluate vulnerability by: Vulnerability = Hazard - Adaptive capacity
## To flooding
Vuln_FLOOD_o <- Hazard_FLOOD_o - AdaptCap
Vuln_FLOOD_m <- Hazard_FLOOD_m - AdaptCap

Vuln_SCARCITY_o <- Hazard_SCARCITY_o - AdaptCap
Vuln_SCARCITY_m <- Hazard_SCARCITY_m - AdaptCap

## for interest- average scarcity and flood vulnerabilities
cmb <- stack(Vuln_FLOOD_m, Vuln_SCARCITY_m)
cmb.m <- calc(cmb, fun = mean)

#################
## Make plots ##
#################

data(World)
Lakes_ply <- readOGR(dsn=paste("./Lakes", sep=""), layer="ne_10m_lakes")
Lakes_ply$scalerank %<>% as.numeric()
Lakes_large <- subset(Lakes_ply, scalerank < 4)

# remove Greenland for plotting
Grl <- raster("./NaturalEarth/Greenland.tif")
Vuln_SCARCITY_m[Grl[] == 1] <- NA; Vuln_FLOOD_m[Grl[] == 1] <- NA; cmb.m[Grl[] == 1] <- NA

map <- 
  tm_shape(World, projection = "robin") +  tm_polygons(fill = "#c0c0c0") +
  tm_shape(cmb.m, projection = "robin") +
      tm_raster(style = "cont", palette = "-Spectral", midpoint = 0, breaks = c(-1, 1)) +
  # tm_shape(WorldRegions) +   tm_raster(style = "cat", palette = "Set3") +
  tm_shape(World) +  tm_borders(lwd = 0.7) +
  tm_shape(Lakes_large) + tm_borders("black", lwd = 0.5) +
  tm_style("white", legend.show = F, earth.boundary = c(-180, -60, 180, 88), earth.boundary.color = "white",
           space.color = "white", legend.frame = F, frame = F)
map

# save map plot
tmap_save(map, "C:/Users/Tom/Desktop/VULNERABILITY_combined_zscore.png", dpi = 500, 
          outer.margins = 0.01, height = 3, units = "in")

############################################
## Subsequent analysis, for parts c and d ##
############################################

############################### Analysis for part c - scatter plots

# world region ID index: 1 - NAM | 2 - FSU | 3 - POECD | 4 - PAS | 5 - CPA | 6 - SAS | 7 - SSA | 8 _ MENA | 9 - WEUR | 10 - LAM 
GADM <- raster("./GADM/GADM_level0_0d05.tif")
Global_df <- cbind(as.data.frame(GADM), as.data.frame(FPU_grid), 
                   as.data.frame(Vuln_FLOOD_m), as.data.frame(Vuln_SCARCITY_m), 
                   as.data.frame(Hazard_FLOOD_m), as.data.frame(Hazard_SCARCITY_m), 
                   as.data.frame(AdaptCap), as.data.frame(WorldRegions), 
                   as.data.frame(GridArea), as.data.frame(Pop)) %>% 
  set_colnames(c("GADM", "FPU", 
                 "Flooding_v", "Scarcity_v", 
                 "Hazard_f", "Hazard_s", 
                 "AC", "Region", "Area", "Pop"))
Global_df <- Global_df[complete.cases(Global_df),]
Global_df$GADM %<>% as.factor()

Plot_df <- Global_df %>% 
  group_by(GADM) %>%
  summarise(Flood_p50 = weighted.quantile(Flooding_v, Pop, probs = 0.50, na.rm = TRUE),
            Scarcity_p50 = weighted.quantile(Scarcity_v, Pop, probs = 0.50, na.rm = TRUE),
            Hazard_f_p50 = weighted.quantile(Hazard_f, Pop, probs = 0.50, na.rm = TRUE),
            Hazard_s_p50 = weighted.quantile(Hazard_s, Pop, probs = 0.50, na.rm = TRUE),
            AC_p50   = weighted.quantile(AC, Pop, probs = 0.50, na.rm = TRUE),
            Region_main = round(weighted.quantile(Region, Pop, probs = 0.50, na.rm = TRUE), digits = 0),
            Population  = sum(Pop, na.rm = TRUE)) %>%  as.data.frame()

Plot_df$Region_main %<>% as.factor()

# Calculate some global statistics for reference
ref_df <- cbind(as.data.frame(Vuln_FLOOD_m), as.data.frame(Vuln_SCARCITY_m), 
                as.data.frame(Hazard_FLOOD_m), as.data.frame(Hazard_SCARCITY_m),
                as.data.frame(AdaptCap), as.data.frame(Pop)) %>%
  set_colnames(c("Flood_v", "Scarcity_v", "Hazard_f", "Hazard_s","AC", "Pop"))

g_FLD_V_p25 <- weighted.quantile(ref_df$Flood_v, ref_df$Pop, probs = 0.25, na.rm = T)
g_FLD_V_p50 <- weighted.quantile(ref_df$Flood_v, ref_df$Pop, probs = 0.50, na.rm = T)
g_FLD_V_p75 <- weighted.quantile(ref_df$Flood_v, ref_df$Pop, probs = 0.75, na.rm = T)

g_STY_V_p25 <- weighted.quantile(ref_df$Scarcity_v, ref_df$Pop, probs = 0.25, na.rm = T)
g_STY_V_p50 <- weighted.quantile(ref_df$Scarcity_v, ref_df$Pop, probs = 0.50, na.rm = T)
g_STY_V_p75 <- weighted.quantile(ref_df$Scarcity_v, ref_df$Pop, probs = 0.75, na.rm = T)

g_FLD_H_p25 <- weighted.quantile(ref_df$Hazard_f, ref_df$Pop, probs = 0.25, na.rm = T)
g_FLD_H_p50 <- weighted.quantile(ref_df$Hazard_f, ref_df$Pop, probs = 0.50, na.rm = T)
g_FLD_H_p75 <- weighted.quantile(ref_df$Hazard_f, ref_df$Pop, probs = 0.75, na.rm = T)

g_STY_H_p25 <- weighted.quantile(ref_df$Hazard_s, ref_df$Pop, probs = 0.25, na.rm = T)
g_STY_H_p50 <- weighted.quantile(ref_df$Hazard_s, ref_df$Pop, probs = 0.50, na.rm = T)
g_STY_H_p75 <- weighted.quantile(ref_df$Hazard_s, ref_df$Pop, probs = 0.75, na.rm = T)

g_AC_p25 <- weighted.quantile(ref_df$AC, ref_df$Pop, probs = 0.25, na.rm = T)
g_AC_p50 <- weighted.quantile(ref_df$AC, ref_df$Pop, probs = 0.50, na.rm = T)
g_AC_p75 <- weighted.quantile(ref_df$AC, ref_df$Pop, probs = 0.75, na.rm = T)

## import GADM identifier for country names
GADM.id <- read.csv("./GADM/Country_id_gadm.csv") %>% as.data.frame() %>% select("GID_0", "NAME_0", "ID")

Plot_df <- merge(x = Plot_df, y = GADM.id, by.x = "GADM", by.y = "ID", all = F)
Plot_df <- Plot_df[order(-Plot_df$Population),]

figure <- ggplot(data = filter(Plot_df, Population > 5e6), aes(x = Scarcity_p50, y = Flood_p50, label = NAME_0)) +
  geom_vline(xintercept = g_STY_V_p25, lwd = 1.1, color = "grey60") +
  geom_vline(xintercept = g_STY_V_p75, lwd = 1.1, color = "grey60") +
  geom_hline(yintercept = g_FLD_V_p25, lwd = 1.1, color = "grey60") +
  geom_hline(yintercept = g_FLD_V_p75, lwd = 1.1, color = "grey60") +
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.major = element_line(colour = "grey50", linetype = "dashed", size = 0.7),
        legend.title = element_blank(),
        axis.text = element_text(face = "bold", size = 10, color = "black")) +
  geom_jitter(shape = 21, width = 0.0, height = 0.0, aes(fill = Region_main, size = Population), alpha = 1) +
  scale_fill_brewer(palette = "Set3") +
  scale_size(range = c(2, 14), breaks = c(5e6, 50e6, 500e6, 1000e6), labels = c("5M", "50M", "500M", "1B"))+
  # geom_text(size = 3.5) +
  coord_cartesian(xlim = c(-1.05, 1.05), ylim = c(-1.05, 1.05)) +         # this line for vulnerability plot
  scale_x_continuous(expand = c(0, 0),breaks = c(seq(-1, 1, by = 0.5))) + # ... and this line
  scale_y_continuous(expand = c(0, 0), breaks = c(seq(-1, 1, by = 0.5)))  # ... and this line
  # coord_cartesian(xlim = c(-0.05, 1.05), ylim = c(-0.05, 1.05)) +           # this line for hazard plots
  # scale_x_continuous(expand = c(0, 0),breaks = c(seq(0, 1, by = 0.25))) +   # ... and this line
  # scale_y_continuous(expand = c(0, 0), breaks = c(seq(0, 1, by = 0.25)))    # ... and this line
figure

ggsave("C:/Users/Tom/Desktop/SCATTER_comparison_b.png", 
       figure, dpi = 500, width = 0.91508*900*0.2645833333, height = 750*0.2645833333, units = "mm", bg = "transparent")

ggsave("C:/Users/Tom/Desktop/SCATTER_scarcity_hazard_l.png", 
       figure, dpi = 500, width = 2*900*0.2645833333, height = 2*750*0.2645833333, units = "mm", bg = "transparent")


#############. 
## create boxplots for regional summaries

# world region ID index: 1 - NAM | 2 - FSU | 3 - POECD | 4 - PAS | 5 - CPA | 6 - SAS | 7 - SSA | 8 _ MENA | 9 - WEUR | 10 - LAM 
Global_df <- cbind(as.data.frame(GADM), as.data.frame(FPU_grid), 
                   as.data.frame(Vuln_FLOOD_m), as.data.frame(Vuln_SCARCITY_m), 
                   as.data.frame(WorldRegions), as.data.frame(GridArea), as.data.frame(Pop)) %>% 
  set_colnames(c("GADM", "FPU", 
                 "Flooding_v", "Scarcity_v", 
                 "Region", "Area", "Pop"))
Global_df <- Global_df[complete.cases(Global_df),]
Global_df$GADM %<>% as.factor()

Plot_df <- Global_df %>% 
  group_by(Region) %>%
  summarise(
            Scarcity_p05 = weighted.quantile(Scarcity_v, Pop, probs = 0.05, na.rm = TRUE),
            Scarcity_p25 = weighted.quantile(Scarcity_v, Pop, probs = 0.25, na.rm = TRUE),
            Scarcity_p50 = weighted.quantile(Scarcity_v, Pop, probs = 0.50, na.rm = TRUE),
            Scarcity_p75 = weighted.quantile(Scarcity_v, Pop, probs = 0.75, na.rm = TRUE),
            Scarcity_p95 = weighted.quantile(Scarcity_v, Pop, probs = 0.95, na.rm = TRUE),
            
            Flooding_p05 = weighted.quantile(Flooding_v, Pop, probs = 0.05, na.rm = TRUE),
            Flooding_p25 = weighted.quantile(Flooding_v, Pop, probs = 0.25, na.rm = TRUE),
            Flooding_p50 = weighted.quantile(Flooding_v, Pop, probs = 0.50, na.rm = TRUE),
            Flooding_p75 = weighted.quantile(Flooding_v, Pop, probs = 0.75, na.rm = TRUE),
            Flooding_p95 = weighted.quantile(Flooding_v, Pop, probs = 0.95, na.rm = TRUE),
            
            ) %>%  as.data.frame()

Plot_df$Region %<>% as.factor()
library(forcats)
boxplot_s <- ggplot(Plot_df, aes(x = fct_reorder(Region, Scarcity_p50),
                               ymin = Scarcity_p05, lower = Scarcity_p25, middle = Scarcity_p50,
                               upper = Scarcity_p75, ymax = Scarcity_p95, fill = Region)) +
  # scale_x_discrete(limsits=c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")) +
  geom_boxplot(stat = "identity") +  scale_fill_brewer(palette="Set3") +
  # scale_y_continuous(breaks = seq(-3, 3, by = 1), expand = c(0,0)) +
  theme(panel.background =  element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(),
        panel.grid.major = element_line(alpha(colour = "white", 0.3), linetype = "dashed", size = 0.5),
        axis.line.x = element_line(color = "black", size = 1)) +
  coord_flip(ylim = c(-1, 1))
boxplot_s

boxplot_f <- ggplot(Plot_df, aes(x = fct_reorder(Region, Flooding_p50),
                                 ymin = Flooding_p05, lower = Flooding_p25, middle = Flooding_p50,
                                 upper = Flooding_p75, ymax = Flooding_p95, fill = Region)) +
  # scale_x_discrete(limsits=c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")) +
  geom_boxplot(stat = "identity") +  scale_fill_brewer(palette="Set3") +
  # scale_y_continuous(breaks = seq(-3, 3, by = 1), expand = c(0,0)) +
  theme(panel.background =  element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(),
        panel.grid.major = element_line(alpha(colour = "white", 0.3), linetype = "dashed", size = 0.5),
        axis.line.x = element_line(color = "black", size = 1)) +
  coord_flip(ylim = c(-1, 1))
boxplot_f

ggsave("C:/Users/Tom/Desktop/Boxplot_flooding.png", 
       boxplot_f, dpi = 500, width = 800*0.2645833333, height = 700*0.2645833333, units = "mm", bg = "transparent")

ggsave("C:/Users/Tom/Desktop/Boxplot_scarcity.png", 
       boxplot_s, dpi = 500, width = 800*0.2645833333, height = 700*0.2645833333, units = "mm", bg = "transparent")
